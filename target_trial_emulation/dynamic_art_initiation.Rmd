---
title: "Causal Effects of Dynamic Antiretroviral Therapy Initiation Strategies Using Cloning–Censoring–Weighting and Inverse Probability Weighting"
author: "Hajin Jang"
date: "2025-04-16"
output: html_document
---

### This analysis estimates the causal effects of dynamic antiretroviral therapy initiation strategies defined by CD4 thresholds using a cloning–censoring–weighting approach with inverse probability weighting.


## Read data

```{r setup, include=FALSE}
#install packages
library(dplyr)
library(ggplot2)

#read in dataset
dat <- read.csv("artwhen.csv")

summary(dat)
nrow(dat)
nrow(dat[!duplicated(dat[,'id']),])

subset(dat,id==93003)[,c('id','month','art','cd4_v','min_cd4_v')]
subset(dat,id==93006)[,c('id','month','art','cd4_v','min_cd4_v')]
```


## Estimating probabilities for the denominator of the inverse probability weights

```{r}
mod <- glm(art ~ month + monthsq
	+ factor(age_0_cat) + SEX + factor(origin) + factor(mode)
	+ factor(year_0_cat) + factor(cd4_0_cat) + factor(rna_0_cat)
	+ factor(cd4_v_cat) + factor(rna_v_cat),
	family = binomial(), data = subset(dat,eligible2==1))

dat$probA.d <- ifelse(dat$eligible2==1,
	predict(mod, type = 'response'),NA)
```

**Comment:** This part of the code sets up the longitudinal dataset and models the probability of ART initiation given baseline and time-varying covariates. The resulting predicted probabilities capture how treatment initiation depends on evolving clinical status, which is essential for constructing inverse probability weights that appropriately adjust for time-varying confounding.


## Creating replicates of the persons for all the treatment strategies of interest

```{r}
for(i in 1:7) {
	dat[[paste('regime',i,sep='')]] <- i
}

datrep <- reshape(dat,varying=c('regime1',
	'regime2','regime3','regime4',
	'regime5','regime6','regime7'),
	v.names='regime',
	idvar=c('id','month'),
	direction='long')

datrep$threshold <- 200+(datrep$regime-1)*50
datrep$newid <- with(datrep,interaction(id,regime))

summary(factor(subset(datrep,month==0)$threshold))
summary(factor(datrep$threshold))

datrep$min.allowed <- ifelse(datrep$art_base==1,
	50*ceiling((datrep$cd4_0+1)/50),0)
datrep <- subset(datrep, threshold>=min.allowed)
datrep$max.allowed <- ifelse(datrep$art_base==0,
  	50*floor(datrep$cd4_0/50),500)
datrep <- subset(datrep, threshold<=max.allowed)

summary(factor(subset(datrep,month==0)$threshold))

subset(datrep,id==93003 & month==0)[,c('art','cd4_v',
'threshold','min.allowed','max.allowed')]
subset(datrep,id==93006 & month==0)[,c('art','cd4_v',
'threshold','min.allowed','max.allowed')]
```

**Cloning Individuals to Represent Dynamic Treatment Strategies:** Each individual is cloned into multiple copies, one for each dynamic treatment strategy defined by different CD4 thresholds for ART initiation. This restructuring allows the observed data to be re-used to emulate multiple hypothetical treatment strategies simultaneously, forming the basis of the cloning–censoring–weighting approach.


## Censoring replicates when deviating from assigned strategy

```{r}
datrep$c <- rep(0,nrow(datrep))
datrep$elig.c <- rep(NA,nrow(datrep))

datrep$elig.c <- ifelse(datrep$art_base==1,0,1)

datrep$c <- ifelse(datrep$art==0 
	& datrep$threshold>datrep$cd4_v & datrep$elig.c==1,
	1,datrep$c)
datrep$c <- ifelse(datrep$art==1 
	& datrep$threshold<=datrep$min_cd4_v & datrep$elig.c==1,
	1,datrep$c)

datrep$c <- ave(datrep$c,datrep$newid,
	FUN=function(x) ifelse(cumsum(x)>0,1,0))

datrep$aidsdeath <- ifelse(datrep$c==1,NA,datrep$aidsdeath)
datrep$censor <- ifelse(datrep$c==1,NA,datrep$censor)
datrep <- subset(datrep,c==0)

summary(factor(datrep$threshold))
table(datrep$regime,datrep$aidsdeath)

summary(factor(subset(datrep,id==93003)$threshold))
summary(factor(subset(datrep,id==93006)$threshold))
```

**Artificial Censoring Based on Strategy Adherence:** In this step, each clone is artificially censored at the moment the observed treatment behavior deviates from the assigned strategy. As a result, only the portions of follow-up that are consistent with each strategy are retained, ensuring that each clone represents adherence to its assigned dynamic regime.


## Estimating the non-stabilized inverse probability weights

```{r}
datrep$denA.line <- ifelse(datrep$eligible2==0,1,
	ifelse(datrep$art==0,
		1-datrep$probA.d,
		datrep$probA.d))

datrep$dencum <- ave(datrep$denA.line,datrep$newid,
	FUN=function(x) cumprod(x))

datrep$w <- 1/datrep$dencum
datrep$w <- ifelse(is.na(datrep$aidsdeath),NA,datrep$w)
datrep <- subset(datrep,is.na(w)==FALSE)
```


## Truncating the weights

```{r}
summary(datrep$w)

trunc.cutoff <- quantile(datrep$w,0.98,na.rm=TRUE)
datrep$w.trunc <- ifelse(datrep$w<trunc.cutoff,
	datrep$w,trunc.cutoff)
summary(datrep$w.trunc)

summary(datrep$w)
datrep$w.trunc <- datrep$w
summary(datrep$w.trunc)
```

**Construction and Truncation of Inverse Probability Weights:** The inverse probability weights are constructed by accumulating the inverse of the conditional treatment probabilities over time. Truncation is applied to limit the influence of extreme weights, reflecting a practical bias–variance tradeoff and improving the stability of the estimated hazard ratios.


## Estimating the hazard ratios

```{r}
#logistic
modw.temp <- glm(aidsdeath ~ relevel(factor(regime),'7') 
+ month + monthsq
	+ factor(age_0_cat) + SEX + factor(origin) + factor(mode)
	+ factor(year_0_cat) + factor(cd4_0_cat) + factor(rna_0_cat),
	family = binomial(), weights = w.trunc, data = datrep)
summary(modw.temp)

beta <- coef(modw.temp)[2:7]
SE <- coef(summary(modw.temp))[2:7, 2]

lcl <- beta - qnorm(0.975) * SE
ucl <- beta + qnorm(0.975) * SE

exp(cbind(OR = beta, CI_lower = lcl, CI_upper = ucl))

#gee
require(geepack)

modw.gee <- geeglm(aidsdeath ~ relevel(factor(regime), '7') 
  + month + monthsq
  + factor(age_0_cat) + SEX + factor(origin) + factor(mode)
  + factor(year_0_cat) + factor(cd4_0_cat) + factor(rna_0_cat),
  data = datrep, 
  weights = w.trunc, 
  id = newid,
  corstr = "independence", 
  family = binomial(link = "logit"))

summary(modw.gee)

beta <- coef(modw.gee)
SE <- coef(summary(modw.gee))[, "Std.err"]
lcl <- beta - qnorm(0.975) * SE
ucl <- beta + qnorm(0.975) * SE

exp.ci <- exp(cbind(beta, lcl, ucl))
colnames(exp.ci) <- c("OR", "Lower 95% CI", "Upper 95% CI")
exp.ci
```

**Estimation and Interpretation of Strategy-Specific Hazard Ratios:** Using the weighted pooled logistic regression, the code estimates hazard ratios comparing each CD4-based treatment strategy to the reference strategy of initiating ART at CD4 ≤ 500. The results indicate that initiating ART at lower CD4 thresholds is generally associated with higher hazards of AIDS or death, with estimates and confidence intervals closely matching the homework results and demonstrating consistency across modeling approaches.


## Wrap-up
Overall, this project emulates a sequence of dynamic treatment strategies and uses cloning, censoring, and inverse probability weighting to estimate their comparative effects on AIDS or death under clearly defined causal assumptions.

