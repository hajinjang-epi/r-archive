---
title: "Causal Inference using Epidemiologic Followup Study (NHEFS) Data"
author: "Hajin Jang"
date: "2/13/2025"
output: html_document
---

### This project applies multiple causal inference methods including inverse probability weighting, standardization, and outcome regression to estimate the causal effect of smoking cessation on 10-year mortality using the NHEFS cohort.


## Library

```{r}
library(dplyr)
library(readr)
library(stats)
library(tidyr)  
library(geepack)
```


## Data

```{r}
data <- read_csv('nhefs.csv')
```


## IPW

```{r}
# data2
data2 <- data %>% 
  select(seqn,qsmk, death, sex, race, age, education, exercise) %>%
  drop_na()

data2 <- data2 %>% mutate(age2 = age^2)

modipw <- glm(qsmk ~ age + age2 + sex + race + factor(education) + factor(exercise), family = binomial(link = "logit"), data = data2)

data2$probA.den <- predict(modipw, type = 'response')
data2$w <- ifelse(data2$qsmk == 1, 1/data2$probA.den, 1/(1 - data2$probA.den))

mod <- geeglm(death ~ qsmk, data=data2, weights=w, id=seqn, family = binomial(link = "logit"), corstr='independence') ##use geeglm for robust variance

summary(mod)
beta <- coef(mod)
SE <- coef(summary(mod))[,2]
lcl <- beta-qnorm(0.975)*SE
ucl <- beta+qnorm(0.975)*SE
cbind(beta, lcl, ucl) 
exp_beta <- exp(beta)
exp_lcl <- exp(lcl)
exp_ucl <- exp(ucl)

exp_beta
exp_lcl
exp_ucl
```

**IPW:** The distribution of the inverse probability weights showed no extreme values, suggesting adequate positivity and limited influence of highly weighted observations on the marginal effect estimates.

After applying inverse probability weighting, the marginal structural model estimated a causal odds ratio of approximately 0.96 for smoking cessation on 10-year mortality, indicating no statistically significant causal effect at the population level.

**Marginal Structural Model:** After applying inverse probability weighting, the marginal structural model estimated a causal odds ratio of approximately 0.96 for smoking cessation on 10-year mortality, indicating no statistically significant causal effect at the population level.

The point estimate suggests a modest protective trend of smoking cessation on mortality; however, the wide confidence interval indicates substantial uncertainty, and the null hypothesis cannot be rejected.


## Standardization

```{r}
# data3
data3 <- data %>%
  select(qsmk, death, sex, race, age) %>%
  drop_na()

data3 <- data3 %>%
  mutate(age_group = ifelse(age >= 50, 1, 0))

dat1 <- data3 #first copy of dataset (equal to original)
dat1$interv <- rep(-1,nrow(dat1))
dat2 <- data3 #second copy of dataset (set tx to 0, outcome to missing)
dat2$interv <- rep(0,nrow(dat2))
dat2$qsmk <- rep(0,nrow(dat2))
dat2$death <- rep(NA,nrow(dat2))
dat3 <- data3 #third copy of dataset (set tx to 1, outcome to missing)
dat3$interv <- rep(1,nrow(dat3))
dat3$qsmk <- rep(1,nrow(dat3))
dat3$death <- rep(NA,nrow(dat3))

onesample <- as.data.frame(rbind(dat1,dat2,dat3))
dim(onesample)
summary(factor(onesample$interv))

# nonparametric standardization
modnonst <-  glm(death~ qsmk * sex * factor(race) * age_group, family=binomial, data = onesample)
summary(modnonst)
onesample$meanY <- predict(modnonst, onesample, type = "response")
with(onesample, format(tapply(meanY, list(interv), mean), digits = 6, nsmall = 5))

# Parametric standardization
modst <- glm(death~ qsmk + sex + factor(race) + age_group, family=binomial, data = onesample)
summary(modst)
onesample$meanY <- predict(modst, onesample, type = "response")
with(onesample, format(tapply(meanY, list(interv), mean), digits = 6, nsmall = 5))
```

**Nonparametric Standardization (RD):** Using nonparametric standardization, the estimated causal risk difference was approximately 0.65%, reflecting a small absolute difference in 10-year mortality risk between cessation groups under minimal modeling assumptions.

This result indicates that had everyone in the population ceased smoking, the absolute 10-year mortality risk would differ by less than 1% compared to had no one quit smoking, highlighting a limited population-level effect.

**Parametric Standardization:** The parametric standardization approach assumes additive effects of smoking cessation and confounders on the log-odds of mortality, providing a more structured but assumption-dependent estimate of the causal risk difference.

The parametric standardization estimate was similar in magnitude to the nonparametric estimate, suggesting robustness of the risk difference to modeling assumptions.


## Outcome Regression

```{r}
# data4
data4 <- data %>%
  select(qsmk, death, sex, race, age, education, exercise) %>%
  drop_na()

# Fit logistic regression model for outcome regression
mod_outcome <- glm(death ~ qsmk + age + sex + race + factor(education) + factor(exercise), family = binomial(link = "logit"), data = data4)

odds_ratio <- exp(coef(mod_outcome)["qsmk"])
conf_int <- exp(confint(mod_outcome)["qsmk", ])

print(odds_ratio, digits = 5)
print(conf_int, digits = 5)

##obtaining E[Y|A,L] estimates from this model
mod_outcome$coeff[1]
mod_outcome$coeff[1]+mod_outcome$coeff[2]
mod_outcome$coeff[1]+mod_outcome$coeff[3]
mod_outcome$coeff[1]+mod_outcome$coeff[2]+mod_outcome$coeff[3]

beta <- coef(mod_outcome)
SE <- coef(summary(mod_outcome))[,2]
lcl <- beta-qnorm(0.975)*SE 
ucl <- beta+qnorm(0.975)*SE
cbind(beta, lcl, ucl) ##valid conservative CI

## exponentiate log odds
OR <- exp(beta)
OR_lcl <- exp(lcl)
OR_ucl <- exp(ucl)
result <- round(cbind(OR, OR_lcl, OR_ucl), 2)
result

OR
OR_lcl
OR_ucl
```

**Outcome Regression Model:** The multivariable logistic regression model estimated a conditional causal odds ratio of approximately 0.93, adjusting for age, sex, race, education, and exercise.

Conditional on measured confounders, smoking cessation was not significantly associated with 10-year mortality, reinforcing consistency with the marginal effect estimates.

**Marginal vs. Conditional Effects:** Although the marginal and conditional estimates target different causal estimands, both approaches yielded similar conclusions, strengthening confidence in the overall inference.

**Modeling Assumptions Assessment:** The analysis relies on key causal assumptions, including conditional exchangeability, positivity, and correct model specification for parametric methods; given these assumptions, the results appear internally consistent across methods.

The convergence of estimates across IPW, standardization, and outcome regression suggests that the findings are not driven by a single modeling strategy.


## Overall Conclusion
Across multiple causal inference approaches, smoking cessation was not found to have a statistically significant causal effect on 10-year mortality in this dataset, underscoring the importance of distinguishing causal estimands and carefully evaluating modeling assumptions.

